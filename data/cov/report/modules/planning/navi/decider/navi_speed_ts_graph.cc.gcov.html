<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - stripped_conv.info - modules/planning/navi/decider/navi_speed_ts_graph.cc</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">modules/planning/navi/decider</a> - navi_speed_ts_graph.cc<span style="font-size: 80%;"> (source / <a href="navi_speed_ts_graph.cc.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">stripped_conv.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">208</td>
            <td class="headerCovTableEntry">213</td>
            <td class="headerCovTableEntryHi">97.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-05-21 16:34:32</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">169</td>
            <td class="headerCovTableEntry">380</td>
            <td class="headerCovTableEntryLo">44.5 %</td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /******************************************************************************</a>
<span class="lineNum">       2 </span>                :            :  * Copyright 2018 The Apollo Authors. All Rights Reserved.
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
<span class="lineNum">       5 </span>                :            :  * you may not use this file except in compliance with the License.
<span class="lineNum">       6 </span>                :            :  * You may obtain a copy of the License at
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * http://www.apache.org/licenses/LICENSE-2.0
<span class="lineNum">       9 </span>                :            :  *
<span class="lineNum">      10 </span>                :            :  * Unless required by applicable law or agreed to in writing, software
<span class="lineNum">      11 </span>                :            :  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
<span class="lineNum">      12 </span>                :            :  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
<span class="lineNum">      13 </span>                :            :  * See the License for the specific language governing permissions and
<span class="lineNum">      14 </span>                :            :  * limitations under the License.
<span class="lineNum">      15 </span>                :            :  *****************************************************************************/
<span class="lineNum">      16 </span>                :            : 
<span class="lineNum">      17 </span>                :            : /**
<span class="lineNum">      18 </span>                :            :  * @file
<span class="lineNum">      19 </span>                :            :  * @brief This file provides the implementation of the class &quot;NaviSpeedTsGraph&quot;.
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : 
<span class="lineNum">      22 </span>                :            : #include &quot;modules/planning/navi/decider/navi_speed_ts_graph.h&quot;
<span class="lineNum">      23 </span>                :            : 
<span class="lineNum">      24 </span>                :            : #include &lt;algorithm&gt;
<span class="lineNum">      25 </span>                :            : 
<span class="lineNum">      26 </span>                :            : #include &quot;cyber/common/log.h&quot;
<span class="lineNum">      27 </span>                :            : #include &quot;modules/common/math/math_utils.h&quot;
<span class="lineNum">      28 </span>                :            : 
<span class="lineNum">      29 </span>                :            : namespace apollo {
<span class="lineNum">      30 </span>                :            : namespace planning {
<span class="lineNum">      31 </span>                :            : 
<span class="lineNum">      32 </span>                :            : using apollo::common::ErrorCode;
<span class="lineNum">      33 </span>                :            : using apollo::common::Status;
<span class="lineNum">      34 </span>                :            : using apollo::common::math::Clamp;
<span class="lineNum">      35 </span>                :            : 
<span class="lineNum">      36 </span>                :            : namespace {
<span class="lineNum">      37 </span>                :            : constexpr double kDoubleEpsilon = 1.0e-6;
<span class="lineNum">      38 </span>                :            : constexpr double kDefaultSStep = 1.0;
<span class="lineNum">      39 </span>                :            : constexpr double kDefaultSMax = 2.0;
<span class="lineNum">      40 </span>                :            : constexpr double kDefaultSafeDistanceRatio = 1.0;
<span class="lineNum">      41 </span>                :            : constexpr double kDefaultSafeDistanceBase = 2.0;
<span class="lineNum">      42 </span>                :            : constexpr double kSafeDistanceSmooth = 3.0;
<span class="lineNum">      43 </span>                :            : constexpr double kFollowSpeedSmooth = 0.25;
<span class="lineNum">      44 </span>                :            : constexpr double kInfinityValue = 1.0e8;
<a name="45"><span class="lineNum">      45 </span>                :            : }  // namespace</a>
<span class="lineNum">      46 </span>                :            : 
<span class="lineNum">      47 </span>                :<span class="lineCov">         50 : static void CheckConstraints(const NaviSpeedTsConstraints&amp; constraints) {</span>
<span class="lineNum">      48 </span>[<span class="branchCov" title="Branch 2 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">         50 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: CheckConstraints&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">      49 </span>                :            : 
<span class="lineNum">      50 </span>[<span class="branchCov" title="Branch 1 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.t_min, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 50 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      51 </span>[<span class="branchCov" title="Branch 1 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.v_max, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 50 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      52 </span>[<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 50 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.v_max, constraints.v_preffered);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">      53 </span>[<span class="branchCov" title="Branch 1 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.a_max, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 50 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      54 </span>[<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 50 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.a_max, constraints.a_preffered);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">      55 </span>[<span class="branchCov" title="Branch 1 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.b_max, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 50 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      56 </span>[<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 50 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.b_max, constraints.b_preffered);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">      57 </span>[<span class="branchCov" title="Branch 1 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.da_max, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 50 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 50 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      58 </span>[<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 50 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]:<span class="lineCov">         50 :   CHECK_GE(constraints.da_max, constraints.da_preffered);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<a name="59"><span class="lineNum">      59 </span>                :<span class="lineCov">         50 : }</span></a>
<span class="lineNum">      60 </span>                :            : 
<span class="lineNum">      61 </span>                :<span class="lineCov">       5593 : static void CombineConstraints(const NaviSpeedTsConstraints&amp; constraints,</span>
<span class="lineNum">      62 </span>                :            :                                NaviSpeedTsConstraints* dst) {
<span class="lineNum">      63 </span>[<span class="branchCov" title="Branch 2 was taken 5593 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 5593 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">       5593 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: CombineConstraints&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 5593 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 5593 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 5593 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">      64 </span>                :            : 
<span class="lineNum">      65 </span>                :<span class="lineCov">       5593 :   dst-&gt;t_min = std::max(constraints.t_min, dst-&gt;t_min);</span>
<span class="lineNum">      66 </span>                :<span class="lineCov">       5593 :   dst-&gt;v_max = std::min(constraints.v_max, dst-&gt;v_max);</span>
<span class="lineNum">      67 </span>                :<span class="lineCov">       5593 :   dst-&gt;v_preffered = std::min(constraints.v_preffered, dst-&gt;v_preffered);</span>
<span class="lineNum">      68 </span>                :<span class="lineCov">       5593 :   dst-&gt;a_max = std::min(constraints.a_max, dst-&gt;a_max);</span>
<span class="lineNum">      69 </span>                :<span class="lineCov">       5593 :   dst-&gt;a_preffered = std::min(constraints.a_preffered, dst-&gt;a_preffered);</span>
<span class="lineNum">      70 </span>                :<span class="lineCov">       5593 :   dst-&gt;b_max = std::min(constraints.b_max, dst-&gt;b_max);</span>
<span class="lineNum">      71 </span>                :<span class="lineCov">       5593 :   dst-&gt;b_preffered = std::min(constraints.b_preffered, dst-&gt;b_preffered);</span>
<span class="lineNum">      72 </span>                :<span class="lineCov">       5593 :   dst-&gt;da_max = std::min(constraints.da_max, dst-&gt;da_max);</span>
<span class="lineNum">      73 </span>                :<span class="lineCov">       5593 :   dst-&gt;da_preffered = std::min(constraints.da_preffered, dst-&gt;da_preffered);</span>
<a name="74"><span class="lineNum">      74 </span>                :<span class="lineCov">       5593 : }</span></a>
<span class="lineNum">      75 </span>                :            : 
<span class="lineNum">      76 </span>                :<span class="lineCov">         14 : NaviSpeedTsGraph::NaviSpeedTsGraph() {</span>
<span class="lineNum">      77 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          7 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: NaviSpeedTsGraph::NaviSpeedTsGraph&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 13 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 14 was not taken"> - </span>][<span class="branchCov" title="Branch 16 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 17 was not taken"> - </span>]
<span class="lineNum">      78 </span>                :            : 
<span class="lineNum">      79 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :   Reset(kDefaultSStep, kDefaultSMax, 0.0, 0.0, 0.0);</span>
<a name="80"><span class="lineNum">      80 </span>                :<span class="lineCov">          7 : }</span></a>
<span class="lineNum">      81 </span>                :            : 
<span class="lineNum">      82 </span>                :<span class="lineCov">         14 : void NaviSpeedTsGraph::Reset(double s_step, double s_max, double start_v,</span>
<span class="lineNum">      83 </span>                :            :                              double start_a, double start_da) {
<span class="lineNum">      84 </span>[<span class="branchCov" title="Branch 2 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">         14 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: NaviSpeedTsGraph::Reset&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">      85 </span>                :            : 
<span class="lineNum">      86 </span>[<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         14 :   CHECK_GT(s_step, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 14 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      87 </span>[<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]:<span class="lineCov">         14 :   CHECK_GE(s_max, s_step);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">      88 </span>[<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         14 :   CHECK_GE(start_v, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 14 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">      89 </span>                :            : 
<span class="lineNum">      90 </span>                :<span class="lineCov">         14 :   s_step_ = s_step;</span>
<span class="lineNum">      91 </span>                :<span class="lineCov">         14 :   start_v_ = start_v;</span>
<span class="lineNum">      92 </span>                :<span class="lineCov">         14 :   start_a_ = start_a;</span>
<span class="lineNum">      93 </span>                :<span class="lineCov">         14 :   start_da_ = start_da;</span>
<span class="lineNum">      94 </span>                :            : 
<span class="lineNum">      95 </span>                :<span class="lineCov">         14 :   auto point_num = (size_t)((s_max + s_step_) / s_step_);</span>
<span class="lineNum">      96 </span>                :<span class="lineCov">         14 :   constraints_.clear();</span>
<span class="lineNum">      97 </span>                :<span class="lineCov">         14 :   constraints_.resize(point_num);</span>
<a name="98"><span class="lineNum">      98 </span>                :<span class="lineCov">         14 : }</span></a>
<span class="lineNum">      99 </span>                :            : 
<span class="lineNum">     100 </span>                :<span class="lineCov">          7 : void NaviSpeedTsGraph::UpdateConstraints(</span>
<span class="lineNum">     101 </span>                :            :     const NaviSpeedTsConstraints&amp; constraints) {
<span class="lineNum">     102 </span>[<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">          7 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: NaviSpeedTsGraph::UpdateConstraints&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">     103 </span>                :            : 
<span class="lineNum">     104 </span>                :<span class="lineCov">          7 :   CheckConstraints(constraints);</span>
<span class="lineNum">     105 </span>                :            : 
<span class="lineNum">     106 </span>[<span class="branchCov" title="Branch 3 was taken 1599 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 1599 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]:<span class="lineCov">       1606 :   for (auto&amp; pc : constraints_) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 9 was taken 1606 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 1599 times"> + </span><span class="branchCov" title="Branch 12 was taken 7 times"> + </span>]
<span class="lineNum">     107 </span>        [<span class="branchCov" title="Branch 1 was taken 1599 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1599 :     CombineConstraints(constraints, &amp;pc);</span>
<span class="lineNum">     108 </span>                :            :   }
<a name="109"><span class="lineNum">     109 </span>                :<span class="lineCov">          7 : }</span></a>
<span class="lineNum">     110 </span>                :            : 
<span class="lineNum">     111 </span>                :<span class="lineCov">         43 : void NaviSpeedTsGraph::UpdateRangeConstraints(</span>
<span class="lineNum">     112 </span>                :            :     double start_s, double end_s, const NaviSpeedTsConstraints&amp; constraints) {
<span class="lineNum">     113 </span>[<span class="branchCov" title="Branch 2 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">         43 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: NaviSpeedTsGraph::UpdateRangeConstraints&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">     114 </span>                :            : 
<span class="lineNum">     115 </span>[<span class="branchCov" title="Branch 1 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">         43 :   CHECK_GE(start_s, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 43 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 43 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">     116 </span>[<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 43 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]:<span class="lineCov">         43 :   CHECK_GE(end_s, start_s);</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">     117 </span>                :<span class="lineCov">         43 :   CheckConstraints(constraints);</span>
<span class="lineNum">     118 </span>                :            : 
<span class="lineNum">     119 </span>                :<span class="lineCov">         43 :   auto start_idx = (size_t)(std::floor(start_s / s_step_));</span>
<span class="lineNum">     120 </span>                :<span class="lineCov">         43 :   auto end_idx = (size_t)(std::ceil(end_s / s_step_));</span>
<span class="lineNum">     121 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 43 times"> + </span>]:<span class="lineCov">         43 :   if (start_idx == end_idx) {</span>
<span class="lineNum">     122 </span>                :<span class="lineNoCov">          0 :     CombineConstraints(constraints, &amp;constraints_[start_idx]);</span>
<span class="lineNum">     123 </span>                :            :   } else {
<span class="lineNum">     124 </span>[<span class="branchCov" title="Branch 0 was taken 1312 times"> + </span><span class="branchCov" title="Branch 1 was taken 43 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1312 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">       1355 :     for (size_t i = start_idx; i &lt; end_idx &amp;&amp; i &lt; constraints_.size(); i++)</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 1312 times"> + </span><span class="branchCov" title="Branch 6 was taken 43 times"> + </span>]
<span class="lineNum">     125 </span>                :<span class="lineCov">       1312 :       CombineConstraints(constraints, &amp;constraints_[i]);</span>
<span class="lineNum">     126 </span>                :            :   }
<a name="127"><span class="lineNum">     127 </span>                :<span class="lineCov">         43 : }</span></a>
<span class="lineNum">     128 </span>                :            : 
<span class="lineNum">     129 </span>                :<span class="lineCov">          7 : void NaviSpeedTsGraph::UpdateObstacleConstraints(double distance,</span>
<span class="lineNum">     130 </span>                :            :                                                  double safe_distance,
<span class="lineNum">     131 </span>                :            :                                                  double following_accel_ratio,
<span class="lineNum">     132 </span>                :            :                                                  double v,
<span class="lineNum">     133 </span>                :            :                                                  double cruise_speed) {
<span class="lineNum">     134 </span>[<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">          7 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: NaviSpeedTsGraph::UpdateObstacleConstraints&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">     135 </span>                :            : 
<span class="lineNum">     136 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          7 :   CHECK_GE(distance, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 7 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">     137 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          7 :   CHECK_GE(safe_distance, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 7 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">     138 </span>[<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 4 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]:<span class="lineCov">          7 :   CHECK_GT(following_accel_ratio, 0.0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 7 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>][<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 7 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">     139 </span>                :            : 
<span class="lineNum">     140 </span>                :            :   // smooth obstacle following
<span class="lineNum">     141 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 7 times"> + </span>]:<span class="lineCov">         14 :   if (distance &gt; safe_distance &amp;&amp;</span>
<span class="lineNum">     142 </span>  [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">         14 :       distance - safe_distance &lt; kSafeDistanceSmooth &amp;&amp;</span>
<span class="lineNum">     143 </span>                :<span class="lineCov">          1 :       std::abs(v - start_v_) &lt; kFollowSpeedSmooth) {</span>
<span class="lineNum">     144 </span>                :<span class="lineNoCov">          0 :     distance = safe_distance;</span>
<span class="lineNum">     145 </span>                :<span class="lineNoCov">          0 :     v = start_v_;</span>
<span class="lineNum">     146 </span>                :            :   }
<span class="lineNum">     147 </span>                :            : 
<span class="lineNum">     148 </span>                :            :   // TODO(all): if v &lt; 0
<span class="lineNum">     149 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :   v = std::max(v, 0.0);</span>
<span class="lineNum">     150 </span>                :            : 
<span class="lineNum">     151 </span>                :            :   // update t_min
<span class="lineNum">     152 </span>                :<span class="lineCov">          7 :   double s = 0.0;</span>
<span class="lineNum">     153 </span>[<span class="branchCov" title="Branch 3 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]:<span class="lineCov">       1714 :   for (auto&amp; pc : constraints_) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 9 was taken 1714 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 1707 times"> + </span><span class="branchCov" title="Branch 12 was taken 7 times"> + </span>]
<span class="lineNum">     154 </span>                :<span class="lineCov">       1707 :     auto t = (s - distance) / v;</span>
<span class="lineNum">     155 </span>        [<span class="branchCov" title="Branch 0 was taken 975 times"> + </span><span class="branchCov" title="Branch 1 was taken 732 times"> + </span>]:<span class="lineCov">       1707 :     if (t &gt;= 0.0) {</span>
<span class="lineNum">     156 </span>                :<span class="lineCov">        975 :       NaviSpeedTsConstraints constraints;</span>
<span class="lineNum">     157 </span>                :<span class="lineCov">        975 :       constraints.t_min = t;</span>
<span class="lineNum">     158 </span>        [<span class="branchCov" title="Branch 1 was taken 975 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        975 :       CombineConstraints(constraints, &amp;pc);</span>
<span class="lineNum">     159 </span>                :            :     }
<span class="lineNum">     160 </span>                :<span class="lineCov">       1707 :     s += s_step_;</span>
<span class="lineNum">     161 </span>                :            :   }
<span class="lineNum">     162 </span>                :            : 
<span class="lineNum">     163 </span>                :            :   // update v_preffered
<span class="lineNum">     164 </span>                :<span class="lineCov">          7 :   auto od = distance - safe_distance;</span>
<span class="lineNum">     165 </span>                :<span class="lineCov">          7 :   auto v0 = start_v_;</span>
<span class="lineNum">     166 </span>                :<span class="lineCov">          7 :   auto v1 = v;</span>
<span class="lineNum">     167 </span>                :<span class="lineCov">          7 :   auto r0 = (distance - safe_distance) / (distance + safe_distance);</span>
<span class="lineNum">     168 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :   auto vm = std::max(cruise_speed * r0, 0.0) +</span>
<span class="lineNum">     169 </span>                :<span class="lineCov">          7 :             (1.0 + following_accel_ratio * r0) * v1;</span>
<span class="lineNum">     170 </span>                :<span class="lineCov">          7 :   auto ra = (v1 - vm) * (v1 - vm) * (v1 + v0 - 2.0 * vm) / (od * od);</span>
<span class="lineNum">     171 </span>                :<span class="lineCov">          7 :   auto rb = (v1 - vm) * (v1 + 2.0 * v0 - 3.0 * vm) / od;</span>
<span class="lineNum">     172 </span>                :<span class="lineCov">          7 :   auto rc = v0;</span>
<span class="lineNum">     173 </span>                :<span class="lineCov">          7 :   auto t1 = -1.0 * od / (v1 - vm);</span>
<span class="lineNum">     174 </span>                :<span class="lineCov">          7 :   auto s1 = ra * t1 * t1 * t1 + rb * t1 * t1 + rc * t1;</span>
<span class="lineNum">     175 </span>                :            : 
<span class="lineNum">     176 </span>                :            :   double t;
<span class="lineNum">     177 </span>                :            :   double prev_v;
<span class="lineNum">     178 </span>                :<span class="lineCov">          7 :   bool first = true;</span>
<span class="lineNum">     179 </span>[<span class="branchCov" title="Branch 3 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]:<span class="lineCov">       1714 :   for (auto&amp; pc : constraints_) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 9 was taken 1714 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 1707 times"> + </span><span class="branchCov" title="Branch 12 was taken 7 times"> + </span>]
<span class="lineNum">     180 </span>                :<span class="lineCov">       1707 :     NaviSpeedTsConstraints constraints;</span>
<span class="lineNum">     181 </span>                :            : 
<span class="lineNum">     182 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 1700 times"> + </span>]:<span class="lineCov">       1707 :     if (first) {</span>
<span class="lineNum">     183 </span>                :<span class="lineCov">          7 :       first = false;</span>
<span class="lineNum">     184 </span>                :<span class="lineCov">          7 :       auto cur_v = rc;</span>
<span class="lineNum">     185 </span>                :<span class="lineCov">          7 :       t = 0.0;</span>
<span class="lineNum">     186 </span>                :<span class="lineCov">          7 :       s = 0.0;</span>
<span class="lineNum">     187 </span>                :<span class="lineCov">          7 :       prev_v = cur_v;</span>
<span class="lineNum">     188 </span>                :<span class="lineCov">          7 :       constraints.v_preffered = cur_v;</span>
<span class="lineNum">     189 </span>[<span class="branchCov" title="Branch 0 was taken 654 times"> + </span><span class="branchCov" title="Branch 1 was taken 1046 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 654 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       1700 :     } else if (s &lt;= s1 &amp;&amp; t &lt;= t1) {</span>
<span class="lineNum">     190 </span>                :<span class="lineCov">        654 :       auto a = 6.0 * ra * t + 2.0 * rb;</span>
<span class="lineNum">     191 </span>                :<span class="lineCov">        654 :       t += (std::sqrt(prev_v * prev_v + 2.0 * a * s_step_) - prev_v) / a;</span>
<span class="lineNum">     192 </span>                :<span class="lineCov">        654 :       auto cur_v = 3.0 * ra * t * t + 2.0 * rb * t + rc;</span>
<span class="lineNum">     193 </span>                :<span class="lineCov">        654 :       s += s_step_;</span>
<span class="lineNum">     194 </span>                :<span class="lineCov">        654 :       prev_v = cur_v;</span>
<span class="lineNum">     195 </span>        [<span class="branchCov" title="Branch 1 was taken 654 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        654 :       constraints.v_preffered = std::max(cur_v, 0.0);</span>
<span class="lineNum">     196 </span>                :            :     } else {
<span class="lineNum">     197 </span>                :<span class="lineCov">       1046 :       auto cur_v = v;</span>
<span class="lineNum">     198 </span>                :<span class="lineCov">       1046 :       t += 2.0 * s_step_ / (prev_v + cur_v);</span>
<span class="lineNum">     199 </span>                :<span class="lineCov">       1046 :       s += s_step_;</span>
<span class="lineNum">     200 </span>                :<span class="lineCov">       1046 :       prev_v = cur_v;</span>
<span class="lineNum">     201 </span>                :<span class="lineCov">       1046 :       constraints.v_preffered = cur_v;</span>
<span class="lineNum">     202 </span>                :            :     }
<span class="lineNum">     203 </span>                :            : 
<span class="lineNum">     204 </span>        [<span class="branchCov" title="Branch 1 was taken 1707 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1707 :     CombineConstraints(constraints, &amp;pc);</span>
<span class="lineNum">     205 </span>                :            :   }
<a name="206"><span class="lineNum">     206 </span>                :<span class="lineCov">          7 : }</span></a>
<span class="lineNum">     207 </span>                :            : 
<span class="lineNum">     208 </span>                :<span class="lineCov">          7 : Status NaviSpeedTsGraph::Solve(std::vector&lt;NaviSpeedTsPoint&gt;* output) {</span>
<span class="lineNum">     209 </span>[<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>][<span class="branchCov" title="Branch 5 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]:<span class="lineCov">          7 :     AINFO&lt;&lt;&quot;(DMCZP) EnteringMethod: NaviSpeedTsGraph::Solve&quot;;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 11 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 14 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">     210 </span>                :            : 
<span class="lineNum">     211 </span>                :<span class="lineCov">          7 :   CHECK_NOTNULL(output);</span>
<span class="lineNum">     212 </span>                :            : 
<span class="lineNum">     213 </span>                :            :   // make constraints of the first point
<span class="lineNum">     214 </span>                :<span class="lineCov">          7 :   auto&amp; constraints = constraints_[0];</span>
<span class="lineNum">     215 </span>                :<span class="lineCov">          7 :   constraints.v_max = start_v_;</span>
<span class="lineNum">     216 </span>                :<span class="lineCov">          7 :   constraints.v_preffered = start_v_;</span>
<span class="lineNum">     217 </span>                :<span class="lineCov">          7 :   constraints.a_max = start_a_;</span>
<span class="lineNum">     218 </span>                :<span class="lineCov">          7 :   constraints.a_preffered = start_a_;</span>
<span class="lineNum">     219 </span>                :<span class="lineCov">          7 :   constraints.da_max = start_da_;</span>
<span class="lineNum">     220 </span>                :<span class="lineCov">          7 :   constraints.da_preffered = start_da_;</span>
<span class="lineNum">     221 </span>                :            : 
<span class="lineNum">     222 </span>                :            :   // preprocess v_max base on b_max
<span class="lineNum">     223 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">       1599 :   for (ssize_t i = constraints_.size() - 2; i &gt;= 0; i--) {</span>
<span class="lineNum">     224 </span>                :<span class="lineCov">       1592 :     const auto&amp; next = constraints_[i + 1];</span>
<span class="lineNum">     225 </span>                :<span class="lineCov">       1592 :     auto&amp; cur = constraints_[i];</span>
<span class="lineNum">     226 </span>                :            :     cur.v_max =
<span class="lineNum">     227 </span>                :<span class="lineCov">       1592 :         std::min(std::sqrt(next.v_max * next.v_max + 2 * next.b_max * s_step_),</span>
<span class="lineNum">     228 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1592 :                  cur.v_max);</span>
<span class="lineNum">     229 </span>                :<span class="lineCov">       1592 :     cur.v_preffered = std::min(cur.v_max, cur.v_preffered);</span>
<span class="lineNum">     230 </span>                :            :   }
<span class="lineNum">     231 </span>                :            : 
<span class="lineNum">     232 </span>                :            :   // preprocess v_max base on a_max
<span class="lineNum">     233 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">       1599 :   for (size_t i = 1; i &lt; constraints_.size(); i++) {</span>
<span class="lineNum">     234 </span>                :<span class="lineCov">       1592 :     const auto&amp; prev = constraints_[i - 1];</span>
<span class="lineNum">     235 </span>                :<span class="lineCov">       1592 :     auto&amp; cur = constraints_[i];</span>
<span class="lineNum">     236 </span>                :            :     cur.v_max =
<span class="lineNum">     237 </span>                :<span class="lineCov">       1592 :         std::min(std::sqrt(prev.v_max * prev.v_max + 2 * cur.a_max * s_step_),</span>
<span class="lineNum">     238 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1592 :                  cur.v_max);</span>
<span class="lineNum">     239 </span>                :<span class="lineCov">       1592 :     cur.v_preffered = std::min(cur.v_max, cur.v_preffered);</span>
<span class="lineNum">     240 </span>                :            :   }
<span class="lineNum">     241 </span>                :            : 
<span class="lineNum">     242 </span>                :            :   // preprocess v_preffered base on b_preffered
<span class="lineNum">     243 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">       1599 :   for (ssize_t i = constraints_.size() - 2; i &gt;= 0; i--) {</span>
<span class="lineNum">     244 </span>                :<span class="lineCov">       1592 :     const auto&amp; next = constraints_[i + 1];</span>
<span class="lineNum">     245 </span>                :<span class="lineCov">       1592 :     auto&amp; cur = constraints_[i];</span>
<span class="lineNum">     246 </span>                :<span class="lineCov">       1592 :     cur.v_preffered = std::min(std::sqrt(next.v_preffered * next.v_preffered +</span>
<span class="lineNum">     247 </span>                :<span class="lineCov">       1592 :                                          2 * next.b_preffered * s_step_),</span>
<span class="lineNum">     248 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1592 :                                cur.v_preffered);</span>
<span class="lineNum">     249 </span>                :            :   }
<span class="lineNum">     250 </span>                :            : 
<span class="lineNum">     251 </span>                :            :   // preprocess v_preffered base on a_preffered
<span class="lineNum">     252 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">       1599 :   for (size_t i = 1; i &lt; constraints_.size(); i++) {</span>
<span class="lineNum">     253 </span>                :<span class="lineCov">       1592 :     const auto&amp; prev = constraints_[i - 1];</span>
<span class="lineNum">     254 </span>                :<span class="lineCov">       1592 :     auto&amp; cur = constraints_[i];</span>
<span class="lineNum">     255 </span>                :<span class="lineCov">       1592 :     cur.v_preffered = std::min(std::sqrt(prev.v_preffered * prev.v_preffered +</span>
<span class="lineNum">     256 </span>                :<span class="lineCov">       1592 :                                          2 * cur.a_preffered * s_step_),</span>
<span class="lineNum">     257 </span>        [<span class="branchCov" title="Branch 1 was taken 1592 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1592 :                                cur.v_preffered);</span>
<span class="lineNum">     258 </span>                :            :   }
<span class="lineNum">     259 </span>                :            : 
<span class="lineNum">     260 </span>                :<span class="lineCov">          7 :   auto&amp; points = *output;</span>
<span class="lineNum">     261 </span>                :<span class="lineCov">          7 :   points.resize(constraints_.size());</span>
<span class="lineNum">     262 </span>                :            : 
<span class="lineNum">     263 </span>                :            :   // compute the first point
<span class="lineNum">     264 </span>                :<span class="lineCov">          7 :   auto&amp; point = points[0];</span>
<span class="lineNum">     265 </span>                :<span class="lineCov">          7 :   point.s = 0.0;</span>
<span class="lineNum">     266 </span>                :<span class="lineCov">          7 :   point.t = 0.0;</span>
<span class="lineNum">     267 </span>                :<span class="lineCov">          7 :   point.v = start_v_;</span>
<span class="lineNum">     268 </span>                :<span class="lineCov">          7 :   point.a = start_a_;</span>
<span class="lineNum">     269 </span>                :<span class="lineCov">          7 :   point.da = start_da_;</span>
<span class="lineNum">     270 </span>                :            : 
<span class="lineNum">     271 </span>                :            :   // compute the remaining points
<span class="lineNum">     272 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">        899 :   for (size_t i = 1; i &lt; points.size(); i++) {</span>
<span class="lineNum">     273 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     const auto&amp; prev = points[i - 1];</span>
<span class="lineNum">     274 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     const auto&amp; constraints = constraints_[i];</span>
<span class="lineNum">     275 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     auto&amp; cur = points[i];</span>
<span class="lineNum">     276 </span>                :            : 
<span class="lineNum">     277 </span>                :            :     // compute t_min base on v_max
<span class="lineNum">     278 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     auto t_min = std::max(prev.t, constraints.t_min);</span>
<span class="lineNum">     279 </span>                :<span class="lineCov">        896 :     auto v_max = constraints.v_max;</span>
<span class="lineNum">     280 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     t_min = std::max(prev.t + 2.0 * s_step_ / (prev.v + v_max), t_min);</span>
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>                :            :     // compute t_max base on b_max
<span class="lineNum">     283 </span>                :<span class="lineCov">        896 :     auto t_max = std::numeric_limits&lt;double&gt;::infinity();</span>
<span class="lineNum">     284 </span>                :<span class="lineCov">        896 :     auto b_max = constraints.b_max;</span>
<span class="lineNum">     285 </span>                :<span class="lineCov">        896 :     auto r0 = prev.v * prev.v - 2 * b_max * s_step_;</span>
<span class="lineNum">     286 </span>        [<span class="branchCov" title="Branch 0 was taken 860 times"> + </span><span class="branchCov" title="Branch 1 was taken 36 times"> + </span>]:<span class="lineCov">        896 :     if (r0 &gt; 0.0) {</span>
<span class="lineNum">     287 </span>                :<span class="lineCov">        860 :       t_max = prev.t + (prev.v - std::sqrt(r0)) / b_max;</span>
<span class="lineNum">     288 </span>                :            :     }
<span class="lineNum">     289 </span>                :            :     // if t_max &lt; t_min
<span class="lineNum">     290 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 896 times"> + </span>]:<span class="lineCov">        896 :     if (t_max &lt; t_min) {</span>
<span class="lineNum">     291 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :       AERROR &lt;&lt; &quot;failure to satisfy the constraints.&quot;;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">     292 </span>                :            :       return Status(ErrorCode::PLANNING_ERROR,
<span class="lineNum">     293 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     &quot;failure to satisfy the constraints.&quot;);</span>
<span class="lineNum">     294 </span>                :            :     }
<span class="lineNum">     295 </span>                :            : 
<span class="lineNum">     296 </span>                :            :     // compute t_preffered base on v_preffered
<span class="lineNum">     297 </span>                :<span class="lineCov">        896 :     auto v_preffered = constraints.v_preffered;</span>
<span class="lineNum">     298 </span>                :<span class="lineCov">        896 :     auto t_preffered = prev.t + 2 * s_step_ / (prev.v + v_preffered);</span>
<span class="lineNum">     299 </span>                :            : 
<span class="lineNum">     300 </span>                :<span class="lineCov">        896 :     cur.s = prev.s + s_step_;</span>
<span class="lineNum">     301 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     cur.t = Clamp(t_preffered, t_min, t_max);</span>
<span class="lineNum">     302 </span>                :<span class="lineCov">        896 :     auto dt = cur.t - prev.t;</span>
<span class="lineNum">     303 </span>        [<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        896 :     cur.v = std::max(2.0 * s_step_ / dt - prev.v, 0.0);</span>
<span class="lineNum">     304 </span>                :            : 
<span class="lineNum">     305 </span>                :            :     // if t is infinity
<span class="lineNum">     306 </span>[<span class="branchCov" title="Branch 1 was taken 896 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 4 times"> + </span><span class="branchCov" title="Branch 4 was taken 892 times"> + </span>]:<span class="lineCov">        896 :     if (std::isinf(cur.t)) {</span>
<span class="lineNum">     307 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          4 :       points.resize(i + 1);</span>
<span class="lineNum">     308 </span>                :<span class="lineCov">          4 :       break;</span>
<span class="lineNum">     309 </span>                :            :     }
<span class="lineNum">     310 </span>                :            :   }
<span class="lineNum">     311 </span>                :            : 
<span class="lineNum">     312 </span>        [<span class="branchCov" title="Branch 1 was taken 889 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">        896 :   for (size_t i = 1; i &lt; points.size() - 1; i++) {</span>
<span class="lineNum">     313 </span>                :<span class="lineCov">        889 :     const auto&amp; prev = points[i - 1];</span>
<span class="lineNum">     314 </span>                :<span class="lineCov">        889 :     const auto&amp; next = points[i + 1];</span>
<span class="lineNum">     315 </span>                :<span class="lineCov">        889 :     auto&amp; cur = points[i];</span>
<span class="lineNum">     316 </span>                :<span class="lineCov">        889 :     auto ds = next.s - prev.s;</span>
<span class="lineNum">     317 </span>                :<span class="lineCov">        889 :     auto dt = next.t - prev.t;</span>
<span class="lineNum">     318 </span>                :<span class="lineCov">        889 :     cur.v = ds / dt;</span>
<span class="lineNum">     319 </span>                :            :   }
<span class="lineNum">     320 </span>                :            : 
<span class="lineNum">     321 </span>                :<span class="lineCov">          7 :   auto&amp; first = points[0];</span>
<span class="lineNum">     322 </span>                :<span class="lineCov">          7 :   const auto&amp; second = points[1];</span>
<span class="lineNum">     323 </span>                :<span class="lineCov">          7 :   first.a = (second.v - first.v) / (2.0 * (second.t - first.t));</span>
<span class="lineNum">     324 </span>                :            : 
<span class="lineNum">     325 </span>        [<span class="branchCov" title="Branch 1 was taken 889 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">        896 :   for (size_t i = 1; i &lt; points.size() - 1; i++) {</span>
<span class="lineNum">     326 </span>                :<span class="lineCov">        889 :     const auto&amp; prev = points[i - 1];</span>
<span class="lineNum">     327 </span>                :<span class="lineCov">        889 :     const auto&amp; next = points[i + 1];</span>
<span class="lineNum">     328 </span>                :<span class="lineCov">        889 :     auto&amp; cur = points[i];</span>
<span class="lineNum">     329 </span>                :<span class="lineCov">        889 :     auto dv = next.v - prev.v;</span>
<span class="lineNum">     330 </span>                :<span class="lineCov">        889 :     auto dt = next.t - prev.t;</span>
<span class="lineNum">     331 </span>                :<span class="lineCov">        889 :     cur.a = dv / dt;</span>
<span class="lineNum">     332 </span>                :            :   }
<span class="lineNum">     333 </span>                :            : 
<span class="lineNum">     334 </span>        [<span class="branchCov" title="Branch 1 was taken 889 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">        896 :   for (size_t i = 1; i &lt; points.size() - 1; i++) {</span>
<span class="lineNum">     335 </span>                :<span class="lineCov">        889 :     const auto&amp; prev = points[i - 1];</span>
<span class="lineNum">     336 </span>                :<span class="lineCov">        889 :     const auto&amp; next = points[i + 1];</span>
<span class="lineNum">     337 </span>                :<span class="lineCov">        889 :     auto&amp; cur = points[i];</span>
<span class="lineNum">     338 </span>                :<span class="lineCov">        889 :     auto da = next.a - prev.a;</span>
<span class="lineNum">     339 </span>                :<span class="lineCov">        889 :     auto dt = next.t - prev.t;</span>
<span class="lineNum">     340 </span>                :<span class="lineCov">        889 :     cur.da = da / dt;</span>
<span class="lineNum">     341 </span>                :            :   }
<span class="lineNum">     342 </span>                :            : 
<span class="lineNum">     343 </span>        [<span class="branchCov" title="Branch 1 was taken 900 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span>]:<span class="lineCov">        907 :   for (size_t i = 0; i &lt; points.size(); i++) {</span>
<span class="lineNum">     344 </span>                :<span class="lineCov">        900 :     auto&amp; point = points[i];</span>
<span class="lineNum">     345 </span>                :<span class="lineCov">        900 :     point.s = std::min(kInfinityValue, point.s);</span>
<span class="lineNum">     346 </span>                :<span class="lineCov">        900 :     point.t = std::min(kInfinityValue, point.t);</span>
<span class="lineNum">     347 </span>                :<span class="lineCov">        900 :     point.v = std::min(kInfinityValue, point.v);</span>
<span class="lineNum">     348 </span>                :<span class="lineCov">        900 :     point.a = std::min(kInfinityValue, point.a);</span>
<span class="lineNum">     349 </span>                :<span class="lineCov">        900 :     point.da = std::min(kInfinityValue, point.da);</span>
<span class="lineNum">     350 </span>                :            : 
<span class="lineNum">     351 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 896 times"> + </span>]:<span class="lineCov">        900 :     if (std::abs(point.t - kInfinityValue) &lt; kDoubleEpsilon)</span>
<span class="lineNum">     352 </span>                :<span class="lineCov">          4 :       points.resize(i + 1);</span>
<span class="lineNum">     353 </span>                :            :   }
<span class="lineNum">     354 </span>                :            : 
<span class="lineNum">     355 </span>                :<span class="lineCov">          7 :   return Status::OK();</span>
<span class="lineNum">     356 </span>                :            : }
<span class="lineNum">     357 </span>                :            : 
<span class="lineNum">     358 </span>                :            : }  // namespace planning
<span class="lineNum">     359 </span>                :            : }  // namespace apollo
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
